###################################################################
# doc/docbook/Makefile
# $Id: Makefile.in,v 1.7 2002/12/13 22:41:24 bdenney Exp $
#
# Builds documentation in various formats from SGML source, and
# allows easy update to the Bochs web site.
#
###################################################################

prefix          = @prefix@
srcdir          = @srcdir@
docdir          = $(prefix)/share/doc/bochs
DOCBOOK2HTML = @DOCBOOK2HTML@

# name of the major documentation sections
SECTIONS=user documentation development
SECTION_HTML=$(SECTIONS:%=%/book1.html)

# these files get installed in addition to the sections
EXTRAS=README index.html

# complete list of what to install
INSTALL_LIST=$(SECTIONS) $(EXTRAS)

# ssh to this server to install the docs
REMOTE_HOST=shell.sf.net

# path of preexisting install on the remote server.  Each section
# will go into a subdirectory of $REMOTE_PATH, as in
# $REMOTE_PATH/user.
REMOTE_PATH=/home/groups/b/bo/bochs/htdocs/doc/docbook

# -x means don't try to forward X authorization, it won't work for SF
SSH=ssh -x

all: $(SECTION_HTML)

user/book1.html: $(srcdir)/user/user.dbk
	-mkdir user
	$(DOCBOOK2HTML) -o user $(srcdir)/user/user.dbk
documentation/book1.html: $(srcdir)/documentation/documentation.dbk
	-mkdir documentation
	$(DOCBOOK2HTML) -o documentation $(srcdir)/documentation/documentation.dbk 
development/book1.html: $(srcdir)/development/development.dbk
	-mkdir development
	$(DOCBOOK2HTML) -o development $(srcdir)/development/development.dbk

fixperm::
	# fix permissions locally so that tar will install things right
	chmod 664 `find $(INSTALL_LIST) -type f -print`
	chmod 775 `find $(INSTALL_LIST) -type d -print`

install: all
	for i in $(INSTALL_LIST); do cp -r $$i $(DESTDIR)$(docdir); done

test_sfuser:
	@if test "$$SFUSER" = ""; then SFUSER=`whoami`; export SFUSER; fi; \
	  echo Your Source Forge username is $${SFUSER}.
	@echo 'If this is not correct, set the environment variable $$SFUSER.'

# Install the stuff on the remote server using ssh.  It will assume that your
# local username is the same as your Source Forge username, unless you define
# an environment variable SFUSER.
webinst: all fixperm
	for i in $(INSTALL_LIST); do if test -a $(srcdir)/$$i -a ! -a $$i; then cp $(srcdir)/$$i $$i; fi; done
	# copy to remote
	@echo Installing documentation on $(REMOTE_PATH)
	tar cf - $(INSTALL_LIST) | gzip > bochsdoc.tar.gz
	if test "$$SFUSER" = ""; then SFUSER=`whoami`; export SFUSER; fi; \
	  gunzip -c bochsdoc.tar.gz | \
	  $(SSH) $${SFUSER}@$(REMOTE_HOST) "cd $(REMOTE_PATH) && umask 002 && tar xvf -"

clean:
	#remove generated files
	for S in $(SECTIONS); do \
	  rm -f $$S/*.html $$S/*.htm $$S/*.ps $$S/*.pdf $$S/*.out; \
	done
	@RMCOMMAND@ bochsdoc.tar.gz

dist-clean: clean
	rm -f  Makefile
